
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Generating Virtual FC WWPNs for a Storage Lab - Gavrie's Blog</title>
  <meta name="author" content="Gavrie Philipson">

  
  <meta name="description" content="At work, I encountered an interesting problem: While testing the Fibre Channel (FC)
scalability of a storage product, we needed to create a lot of FC &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://philipson.co.il/blog/2012/02/16/generating-virtual-fc-wwpns-for-a-storage-lab/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gavrie's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gavrie's Blog</a></h1>
  
    <h2>Whatever I find interesting.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:philipson.co.il" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Generating Virtual FC WWPNs for a Storage Lab</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-16T16:30:00+02:00" pubdate data-updated="true">Feb 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>At work, I encountered an interesting problem: While testing the Fibre Channel (FC)
scalability of a storage product, we needed to create a <em>lot</em> of FC connections between hosts and the storage system. This would in turn require a large number of FC Initiators, each of which having a unique <a href="http://en.wikipedia.org/wiki/World_Wide_Port_Name">World-Wide Port Name (WWPN)</a>.</p>

<p>The easiest and cheapest method to set up a lot of initiators without actually purchasing zillions of FC HBAs would be to use <a href="http://en.wikipedia.org/wiki/NPIV">N_Port ID Virtualization</a>, a.k.a. NPIV. This method allows a single FC HBA to present itself to the FC fabric with multiple WWPNs. This, in turn, allows the creation of many connections to the target storage device from a small number of hosts.</p>

<h2>The Problem</h2>

<p>WWPNs can&#8217;t just be pulled out of thin air. They are allocated &#8211; in chunks &#8211; by a central authority, the <a href="http://standards.ieee.org/develop/regauth/">IEEE Registration Authority</a>. Just making up random WWPNs could cause trouble for two reasons:</p>

<ol>
<li>The WWPN must be unique on the fabric, which means it must be generated in a deterministic way so that two hosts won&#8217;t be using the same WWPN and thereby confuse the fabric.</li>
<li>The WWPN should not have a chance of clashing with official WWPNs of purchased HBAs.</li>
</ol>


<p>With physical (as opposed to virtual) HBAs, this is managed by allocating a OUI (Organizationally Unique Identifier) to every vendor, who in turns tacks on his own vendor-specific serial number to come up with a unique WWPN. This is similar to the MAC address allocation of Ethernet, Wi-Fi and Bluetooth devices.</p>

<p>The textbook solution for our problem would have involved the use of an officially allocated OUI to generate legal WWPNs, but that seemed like overkill for lab project which would never be used on a production SAN.</p>

<!-- more -->


<h2>Some Background</h2>

<p>We now require a kind of a compromise which takes care of the above two issues without causing too much bureaucratic pain. To reach such a solution, we&#8217;ll refer to the IEEE&#8217;s <a href="http://standards.ieee.org/develop/regauth/tut/fibre.pdf">Guidelines for Fibre Channel Use of the Organizationally Unique Identifier (OUI)</a>, and cheat a bit.</p>

<p>Let&#8217;s assume that we have an FC HBA with a WWPN of <code>10:00:00:00:c9:93:53:6d</code>.
We&#8217;ll decode it according to the IEEE Guidelines:</p>

<pre><code>10:00:vv:vv:vv:ss:ss:ss
\___/ \______/ \______/
  |      |        |
  |      |        |
  |      |         \__ Vendor-specific part (24 bits)
  |      |
  |       \__ Vendor OUI (24 bits)
  |
   \__ This WWPN uses the Original WWN format
</code></pre>

<p>According to this diagram, our sample WWPN contains the following information:</p>

<ul>
<li>The <code>10:00</code> prefix means that it uses the original WWN format (a.k.a. &#8220;NAA IEEE 48-bit address format&#8221;), as opposed to newer formats that starting with another sequence</li>
<li>The vendor is <code>00:00:c9</code>, which is an OUI belonging to Emulex Corporation
(according to the <a href="http://standards.ieee.org/develop/regauth/oui/oui.txt">OUI list</a>)</li>
<li>The vendor-specific part is <code>93:53:6d</code>, which is 24 bits long</li>
</ul>


<h2>Using One WWPN to Generate Many New Ones</h2>

<p>For every physical WWPN, we need to be able to generate up to 256 virtual WWPNs to be used with NPIV (assuming that each HBA port supports up to 256 virtual ports). The trick lies in reusing the vendor-specific part to generate multiple WWPNs per physical port, each of which would be guaranteed to be unique throughout the lab.</p>

<p>For that, we rely on the existence of a newer WWN format (&#8220;NAA IEEE Registered&#8221;) that has more space for the vendor-specific part:</p>

<pre><code>5v:vv:vv:vs:ss:ss:ss:ss
|\_______/\___________/
|   |        |
|   |        |
|   |         \__ Vendor-specific part (extended to 36 bits)
|   |
|    \__ Vendor OUI (still 24 bits)
|
 \__ Newer WWN format (NAA IEEE Registered)
</code></pre>

<p>Good, we now have 36 bits for the vendor-specific part!</p>

<p>We will use the larger vendor-specific field to include <em>both</em> the vendor-specific part of the physical ports WWPN (which is just 24 bits), <em>and</em> our own 12-bit custom part. This will let us generate up to 2<sup>12</sup> = 4096 virtual ports per physical port, which is more than enough.</p>

<p>Just to be safe, and to avoid a future clash with HBAs from the same vendor who might use the new numbering scheme as well, we&#8217;ll modify the OUI to a currently unused one (<code>0000c8</code> instead of <code>0000c9</code>). This is of course not 100% future-proof, but is good enough for our purposes.</p>

<p>This leads us to the following range of generated WWPNs:</p>

<pre><code>Original WWPN:

    10:00:00:00:c9:93:53:6d, semantically represented as:

    1000 0000c9 93536d
         \____/ \____/
           |      |
         vendor   |
                serial

Generated WWPN range:

    5 0000c8 93536d 000
    5 0000c8 93536d 001
    5 0000c8 93536d 002
    ...
    5 0000c8 93536d fff
      \____/ \____/ \_/
        |      |     |
      vendor   |    custom
             serial
</code></pre>

<h2>Conclusion</h2>

<p>While still being a hack, the above scheme allows us to generate as many WWPNs as we need.</p>

<p>It has the advantage of being intuitive, since it is easy to determine just by looking at the WWPNs which ones of them are physical (starting with <code>1000 0000c9</code>) and which are virtual (starting with <code>5 0000c8</code>).</p>

<p>It also makes it easy to see which virtual WWPNs belong to each physical port, which is important for debugging purposes: The serial number of the physical port (<code>93536d</code>) is part of the virtual port&#8217;s WWPN as well.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Gavrie Philipson</span></span>

      








  


<time datetime="2012-02-16T16:30:00+02:00" pubdate data-updated="true">Feb 16<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/fibre-channel/'>fibre channel</a>, <a class='category' href='/blog/categories/storage/'>storage</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://philipson.co.il/blog/2012/02/16/generating-virtual-fc-wwpns-for-a-storage-lab/" data-via="gavrieph" data-counturl="http://philipson.co.il/blog/2012/02/16/generating-virtual-fc-wwpns-for-a-storage-lab/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/02/16/improving-readability-and-flow-control-in-python/" title="Previous Post: Improving readability and flow control in Python">&laquo; Improving readability and flow control in Python</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/06/15/the-yagni-slash-nih-conundrum/" title="Next Post: The YAGNI/NIH Conundrum">The YAGNI/NIH Conundrum &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
<section>
  <img src="http://gravatar.com/avatar/cff901a9060e2b4ee1fe095b9fde0679" alt="Gravatar image" title="Gravatar Image" />
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/01/a-subprocess-bug-nah/">A subprocess bug? Nah.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/18/buffers-will-fill-up-eventually/">Buffers will fill Up... Eventually</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/20/why-i-dont-like-rpc/">Why I don't like RPC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/15/the-yagni-slash-nih-conundrum/">The YAGNI/NIH Conundrum</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/16/generating-virtual-fc-wwpns-for-a-storage-lab/">Generating Virtual FC WWPNs for a Storage Lab</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/gavrie">@gavrie</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'gavrie',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("gavrieph", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/gavrieph" class="twitter-follow-button" data-show-count="false">Follow @gavrieph</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Gavrie Philipson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -

<a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a><br />This work by <a xmlns:cc="http://creativecommons.org/ns#" href="http://philipson.co.il/" property="cc:attributionName" rel="cc:attributionURL">Gavrie Philipson</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.

</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'gavriesbl';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://philipson.co.il/blog/2012/02/16/generating-virtual-fc-wwpns-for-a-storage-lab/';
        var disqus_url = 'http://philipson.co.il/blog/2012/02/16/generating-virtual-fc-wwpns-for-a-storage-lab/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: code | Gavrie's Blog]]></title>
  <link href="http://philipson.co.il/blog/categories/code/atom.xml" rel="self"/>
  <link href="http://philipson.co.il/"/>
  <updated>2014-06-19T17:10:05+03:00</updated>
  <id>http://philipson.co.il/</id>
  <author>
    <name><![CDATA[Gavrie Philipson]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Buffers will fill Up... Eventually]]></title>
    <link href="http://philipson.co.il/blog/2014/06/18/buffers-will-fill-up-eventually/"/>
    <updated>2014-06-18T18:42:00+03:00</updated>
    <id>http://philipson.co.il/blog/2014/06/18/buffers-will-fill-up-eventually</id>
    <content type="html"><![CDATA[<p>A colleague asked me to look into a problem with him, mentioning that "Tlib hangs when we run it". Tlib is a fairly large project that is written in Python. His initial analysis showed that it hangs at a very early phase, during with it tries to fetch the latest version to run from a git server. Various users complained about the same problem, suggesting that it is not a local issue.</p>

<p>Running the code, and interrupting it with <code>^C</code> when it hangs, turned up a result similar to the following:</p>

<pre><code>^CTraceback (most recent call last):
  File "./execute_wrong.py", line 8, in &lt;module&gt;
    retval, out, err = execute("git ls-remote")
  File "./execute_wrong.py", line 5, in execute
    retval = p.wait()
  File "/usr/lib/python2.7/subprocess.py", line 1376, in wait
    pid, sts = _eintr_retry_call(os.waitpid, self.pid, 0)
  File "/usr/lib/python2.7/subprocess.py", line 476, in _eintr_retry_call
    return func(*args)
KeyboardInterrupt
</code></pre>

<p>Interesting. The code seems to hang while waiting for the <code>git</code> child process to terminate. However, running <code>git ls-remote</code> from the command line works fine, so why does it hang when run from the code?</p>

<!-- more -->


<h2>Investigating the Issue</h2>

<p>Let's look at the code history to see if anything has changed recently.</p>

<p>Nope. A quick <code>git blame</code> shows that this code is more than 5 years old, and has been performing flawlessly every day since then. So what else has changed?</p>

<p>Let's see what is happening while waiting for the <code>git</code> child process to finish, by running <code>strace</code> on the process:</p>

<pre><code>$ strace -p 5774
Process 5774 attached
write(1, "pull/624/merge\n2fe9da91f5a4b5ba3"..., 4096
</code></pre>

<p>OK. The process is trying to write to <code>stdout</code>, but hanging while doing so. It looks like some buffer is getting filled, which blocks the process from writing further.</p>

<p>Let's look at the size of the data returned by the child process:</p>

<pre><code>$ git ls-remote | wc -c
From gitserver:/git/qa/tlib
   65572
</code></pre>

<p>Aha! This number looks suspiciously like "a bit more than 64k". Which affirms our hypothesis. Let's try to reduce its size by deleting some old remote branches:</p>

<pre><code>$ git push origin :old_branch1
$ git push origin :old_branch2
...
$ git ls-remote | wc -c
From gitserver:/git/qa/tlib
   65368
</code></pre>

<p>Now to run the program again... It worked! The program continues to run successfully.</p>

<h2>The Code</h2>

<p>Here is what the original code looked like (slightly changed to protect the innocent). Can you spot what is wrong?</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>The original code (execute_wrong.py)</span> <a href='/downloads/code/buffers/execute_wrong.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span class='line'>    <span class="n">retval</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">retval</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">retval</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="s">&quot;git ls-remote&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The problem is that we <code>wait()</code> for the process to terminate, without reading its output. Only after it terminates do we read its output. This code has worked correctly for years, since the output was by change smaller than 64k and fitted completely in the pipe's buffer. Once it exceeded the buffer's size due to one remote branch too many, it blocked the process on the pipe, while the parent was waiting for it to terminate. A classic deadlock condition.</p>

<h2>The Fix</h2>

<p>Now that we see the problem, fixing it is simple: First read, then wait.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>The fixed code (execute_right.py)</span> <a href='/downloads/code/buffers/execute_right.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="n">retval</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">retval</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span>
</span><span class='line'>
</span><span class='line'><span class="n">retval</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="s">&quot;git ls-remote&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Conclusion</h2>

<p>Buffers, filesystems, databases will all fill up sometime in the future. Always take this into account when writing code. Any time you generate some data, be sure to set up a process to prune the data and don't assume that it will be OK -- because it will come back to bite you, or at least some future user of your code.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why I don't like RPC]]></title>
    <link href="http://philipson.co.il/blog/2012/06/20/why-i-dont-like-rpc/"/>
    <updated>2012-06-20T09:47:00+03:00</updated>
    <id>http://philipson.co.il/blog/2012/06/20/why-i-dont-like-rpc</id>
    <content type="html"><![CDATA[<p>Lately I've been working on modifying an architectural aspect of an existing software project. This project makes heavy use of remote execution of code on several hosts. To accomplish this feat, it uses several different methods for remote execution: SSH for running general shell commands, RPyC for executing arbitrary Python code remotely, as well as a couple of proprietary interfaces.</p>

<p>One issue I encountered with the current design is that it is quite difficult to make a clean separation between code running locally and code running remotely. This turns debugging any problem involving execution of remote code into an incredibly complicated endeavor.</p>

<p>Much clarity could be gained by changing the architecture of this project to be more explicitly distributed. This would involve several agents running on multiple hosts that communicate amongst themselves to get the work done. The agents would have a clean and documented API, making them usable and testable as standalone components, as well as allowing them to act on behalf of a central process. All remote execution would be explicit, using one single method for any kind of execution -- be it shell commands, Python code or anything else.</p>

<!-- more -->


<h2>The Problem With RPC</h2>

<p>Our existing codebase makes heavy use of <a href="http://rpyc.sourceforge.net/">RPyC</a>, a native Python RPC implementation, for remote execution of arbitrary Python code on remote machines.</p>

<p>Using a variant of RPC sounds like a great solution. RPyC is also a very nice and seamless tool. Code that is running remotely looks just like code that is running locally. Which is the exact reason for why I <em>don't</em> like using it: I don't want transparent RPC! I want it to be immediately clear which code runs locally and which code runs remotely. "Seamless" RPC encourages the writing of spaghetti code, because it's so easy to mix local and remote code. This makes it deceptively easy to write distributed code without thinking about the design of the API and about which parts should reside on each side of the connection. Code can quickly become an intermix of RPC calls with local calls, causing it to be an opaque blob that is impossible to test or debug. In addition, its performance can quickly deteriorate: Objects are being serialized back and forth all the time, and tens of implicit network round-trips introduce latency all around the code.</p>

<p>Of course, the tool is not necessarily at blame here. The problem may lie with those developers who use it incorrectly, instead of designing a clean distributed model around it -- which is certainly possible. But I tend to find that the thoughts and practices of developers become molded to the tools they have at hand. A tool that encourages calling remote code without a conscious effort makes it too easy to avoid thinking about the distributed design.</p>

<p>So, yes, I don't like RPC, especially not <em>stateful RPC</em> that supports access of remote objects by reference. I can live with simple designs like XML-RPC, supporting value-based RPC with native data types, which are fairly easy to understand and debug: There are no remote objects, just data that is passing back and forth. But I dislike tools that try to hide everything under a shiny exterior, and try to act as if remote code were just the same as local code, and as if remote objects actually exist locally with magic proxies doing all the work behind the scenes.</p>

<p>The above is just one of the issues in the long-standing debate regarding RPC vs. Messaging. If you're at all interested in this debate, I heartily recommend reading some of the <a href="http://steve.vinoski.net/blog/category/rpc/">articles by Steve Vinoski</a>, who is a leading expert on the matter and writes on it very eloquently. <a href="http://qconlondon.com/dl/qcon-london-2009/slides/SteveVinoski_RPCAndItsOffspringConvenientYetFundamentallyFlawed.pdf">This presentation</a> summarizes his viewpoint quite nicely, and I quite agree with many of his points.</p>

<h2>What Now?</h2>

<p>So, I'm looking for a good tool to create a distributed architecture that is based on explicit message passing. It should be able to send and receive native Python data types by value. It should be nicely designed, clearly documented, and should make the distinction between local code and remote code crystal clear to the developer.</p>

<p>I am currently investigating and evaluating several solutions. Most of them are based on the excellent ZeroMQ messaging library, along with some kind of serialization tool such as MsgPack. There are several good candidates. I'll write more about it as I make progress.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The YAGNI/NIH Conundrum]]></title>
    <link href="http://philipson.co.il/blog/2012/06/15/the-yagni-slash-nih-conundrum/"/>
    <updated>2012-06-15T10:38:00+03:00</updated>
    <id>http://philipson.co.il/blog/2012/06/15/the-yagni-slash-nih-conundrum</id>
    <content type="html"><![CDATA[<p><em>Disclaimer:</em> This post is about software development, but it is more about the human side of it than about the technical side. This means you may enjoy it even if you're not a software developer (or a technical person at all).</p>

<p>One of the recurring issues that I encounter as a software developer is that of having to decide where on the scale between YAGNI and NIH I want to be. You are probably wondering what the hell I am talking about (unless you're one of those people who are nodding your head now and smiling), so I'll explain.</p>

<p><a href="http://en.wikipedia.org/wiki/YAGNI">YAGNI</a> stands for "You ain't gonna need it", and refers to a software development principle according to which you don't want to start writing a huge bunch of code up front until you know exactly what you are going to need. Since software requirements change all the time, and one of the common maladies of many code bases is superfluous complexity due to over-engineering and over-abstraction, it makes a lot of sense to implement only what you know you are going to need right now, and leave the rest for later.</p>

<p><a href="http://en.wikipedia.org/wiki/Not_invented_here">NIH</a> stands for "Not Invented Here", and refers to a reluctance among some software developers to base their work on code written by someone else: "Hey, I can do this myself, so why should I use this existing project"? This leads people to reinvent the wheel time and again, creating a proliferation of half-baked solutions to problems that have been solved fairly well at other times and places. In addition to the waste of resources in the creating the solution in the first place, it also creates yet another maintainability headache.</p>

<!-- more -->


<h2>The Conundrum</h2>

<p>I consider myself a firm believer in the YAGNI principle, and a staunch opponent of the NIH syndrome: I try to avoid writing code that could stay unwritten, since I consider a large codebase a liability rather than an asset. Writing more code means having to expend more resources on maintaining it. In many corporate cultures, it also decreases the ability to respond to change, due to a reluctance to throw away existing code (which is often due to sentimental reasons rather than objective ones).</p>

<p>Now, as software developers, many of us would much rather write new code than maintain a bunch of old code.</p>

<p>One reason for this is that old code bases tend to have accumulated a lot of baggage over the years, and we love the idea of getting rid of all that and starting with a fresh, blank page: All those old bugs can be forgotten, all those workarounds and little tricks can be left behind.</p>

<p>Another reason is that good developers love to learn new ideas and techniques and are itching to try them out. Seeing our own old code after a few months or years make us cringe with the feeling, "who was the idiot that wrote this?!". We are sure that the code we're going to write now, with our new and shiny tools, will be better by leaps and bounds. And then the cycle starts all over again.</p>

<h2>Coding in the Corporate World</h2>

<p>I'd like to argue that in the corporate world, as opposed to the Open Source world, writing new code can be an irresponsible thing to do. In the corporate world, we write code not just to scratch our own itches. We're creating something that may very well continue to exist long after we have moved on to greener pastures. Other people will have to maintain what we created. Adhering to good software engineering principles means that not only our own lives will be easier down the road, but also those of other people.</p>

<p>Now, those who profess not to care about the experience of other people, or who think that at the very least it is less important that their own experience, may want to consider a few points:</p>

<p>First of all, those "other people" may be yourselves a few months or years from now, trying to adapt your own code to new requirements. Suddenly, all this code is no longer new nor fun, and you'll have to dig in to adapt it to the required changes.</p>

<p>Second, those other people may be your future co-workers, managers or employees. They will remember what you left them with.</p>

<p>Third, people will appreciate your efforts to make their lives easier (or at least won't hate you for making it harder). This increases the likelihood that they will want to work with you in the future.</p>

<p>So all this makes sense even from a perfectly selfish point of view.</p>

<h2>Conclusion</h2>

<p>When faced with a new software problem to solve, I always spend a significant amount of energy in investigating existing solutions and see if they can work for me. I will resort to writing code only if I fail to find a solution that has enough similarity or has a good enough quality. Of course, as my friend Eli claims, this may very well mean that I often pass on the chance to be creative by deferring to existing solutions. But that's something I can live with: I feel the need to reach the right balance between creativity and responsibility.</p>

<p>I can find creativity in ways other than writing a lot of new code: I'd rather leverage existing code that I like and that is maintained by a third party (which becomes more and more commong with the huge Open Source ecosystem). It is more important to me to feel happy with a solution than it is to prove to myself that I can solve a problem that has been solved before by others. That just seems so wasteful.</p>

<p>In an upcoming post, I will analyze a specific case that I encountered in light of the above thoughts.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Improving readability and flow control in Python]]></title>
    <link href="http://philipson.co.il/blog/2012/02/16/improving-readability-and-flow-control-in-python/"/>
    <updated>2012-02-16T00:31:00+02:00</updated>
    <id>http://philipson.co.il/blog/2012/02/16/improving-readability-and-flow-control-in-python</id>
    <content type="html"><![CDATA[<p>Recently, a colleague and I refactored a piece of existing code that had new
behavior added to it. During the process, we managed to improve the readability of the
code using several techniques that I'll describe below.</p>

<h2>Where We Started</h2>

<p>The original code was fairly simple: It decides whether certain "dead"
components need to be "revived", and presents the user with a prompt to choose
from one of several actions.
Depending on the user's choice, the code then proceeds to take the appropriate action:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>The original code (code0.py)</span> <a href='/downloads/code/flow_control/code0.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">revive_dead_components</span><span class="p">():</span>
</span><span class='line'>    <span class="n">choice</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="s">&#39;&quot;I see dead components...&quot;</span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>       <span class="s">&quot;Do you wish to (r)evive them, (c)ontinue without reviving, or (q)uit?&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="p">{</span> <span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="s">&quot;revive&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="s">&quot;c&quot;</span><span class="p">:</span> <span class="s">&quot;continue&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="s">&quot;Q&quot;</span><span class="p">:</span> <span class="s">&quot;quit&quot;</span><span class="p">},</span>
</span><span class='line'>       <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;quit&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;revive&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">revive_components</span><span class="p">()</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;quit&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="n">TestCannotRunException</span><span class="p">(</span><span class="s">&quot;Dead components exist&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;continue&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Adding New Behavior</h2>

<p>We now wanted to add some new functionality to the above code, namely the ability to
allow the user to select a <em>subset</em> of the components that he wants to revive.</p>

<p>To make things more foolproof, in case the user chose to revive selected
components but then neglected to select any components from the list, the code
would not proceed blindly but rather send the user back to the menu so that he could try again.</p>

<p>The first version of the new code looked like this:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>New behavior, first version (code1.py)</span> <a href='/downloads/code/flow_control/code1.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">revive_dead_components</span><span class="p">():</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">choice</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="s">&#39;&quot;I see dead components...&quot;</span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>            <span class="s">&quot;Do you wish to (r)evive them all, (s)elect components to revive, &quot;</span>
</span><span class='line'>            <span class="s">&quot;(c)ontinue without reviving, d(i)sable reviver, or (q)uit?&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="p">{</span> <span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="s">&quot;revive&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;s&quot;</span><span class="p">:</span> <span class="s">&quot;select&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;c&quot;</span><span class="p">:</span> <span class="s">&quot;continue&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;Q&quot;</span><span class="p">:</span> <span class="s">&quot;quit&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;quit&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;revive&quot;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">revive_components</span><span class="p">()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;quit&quot;</span><span class="p">:</span>
</span><span class='line'>            <span class="k">raise</span> <span class="n">TestCannotRunException</span><span class="p">(</span><span class="s">&quot;Dead components exist&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;continue&quot;</span><span class="p">:</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s">&quot;select&quot;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">selected</span> <span class="o">=</span> <span class="n">show_menu</span><span class="p">(</span><span class="s">&quot;Which components would you like to revive?&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
</span><span class='line'>                <span class="n">revive_components</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Nothing selected...&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>To get the required behavior, we used an infinite <code>while True</code> loop that terminates with an
explicit <code>break</code> when a valid choice is made by the user and reiterates otherwise.
This ensures that we don't continue until a valid choice is made.</p>

<h2>Can We Do Better?</h2>

<p>The problem with the above method is that the flow control is not immediately
apparent when looking at the code: It's not obvious that the infinite loop
should actually terminate in all but one case. A future developer could easily
break this behavior.</p>

<p>In addition, the <code>if</code>/<code>elif</code> ladder becomes a bit too long to read
comfortably.</p>

<p>The second iteration was meant to make the flow control clearer:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Refactoring, first try (code2.py)</span> <a href='/downloads/code/flow_control/code2.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">revive_dead_components</span><span class="p">():</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">InvalidChoiceError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">choice_revive</span><span class="p">():</span>    <span class="n">revive_components</span><span class="p">()</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">choice_quit</span><span class="p">():</span>      <span class="k">raise</span> <span class="n">TestCannotRunException</span><span class="p">(</span><span class="s">&quot;Dead components exist&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">choice_continue_</span><span class="p">():</span> <span class="k">pass</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">choice_select</span><span class="p">():</span>
</span><span class='line'>        <span class="n">selected</span> <span class="o">=</span> <span class="n">show_menu</span><span class="p">(</span><span class="s">&quot;Which components would you like to revive?&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Nothing selected...&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">raise</span> <span class="n">InvalidChoiceError</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">revive_components</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">choice</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="s">&#39;&quot;I see dead components...&quot;</span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>            <span class="s">&quot;Do you wish to (r)evive them all, (s)elect components to revive, &quot;</span>
</span><span class='line'>            <span class="s">&quot;(c)ontinue without reviving, d(i)sable reviver, or (q)uit?&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="p">{</span> <span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="s">&quot;revive&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;s&quot;</span><span class="p">:</span> <span class="s">&quot;select&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;c&quot;</span><span class="p">:</span> <span class="s">&quot;continue&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;Q&quot;</span><span class="p">:</span> <span class="s">&quot;quit&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;quit&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;choice_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">choice</span><span class="p">)()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>        <span class="k">except</span> <span class="n">InvalidChoiceError</span><span class="p">:</span>
</span><span class='line'>            <span class="k">continue</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We use several techniques here to improve the clarity of the code:</p>

<ul>
<li><p>We used internal functions to encapsulate the possible actions to take. The
advantage of using internal functions is that it keeps the external namespace
clean, and the naming of each function makes its purpose quite clear.</p></li>
<li><p>We used a dictionary instead of the <code>if</code>/<code>elif</code> construct. Since Python
doesn't have a <code>switch</code> or <code>case</code> statement, this is a more readable replacement.</p></li>
<li><p>We decided to use an exception to signify, well, <em>exceptional</em> flow control: If the user hasn't
selected any components, this warrants exceptional behavior. This technique is
much debated, but we felt like it was appropriate in this case.</p></li>
<li><p>The function name to be called is determined dynamically at runtime from the
user's selection. The idea was to avoid code duplication by needing to specify the names
of the functions yet again (but see below).</p></li>
</ul>


<h2>Removing Some Coolness For Readability</h2>

<p>My colleague pointed out that the <code>locals().get('choice_%s' % choice)()</code> trick
is not quite readable. I agreed, and was happy to accept his improved proposal:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Refactoring, final version (code3.py)</span> <a href='/downloads/code/flow_control/code3.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">revive_dead_components</span><span class="p">():</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">choice_func</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="s">&#39;&quot;I see dead components...&quot;</span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>            <span class="s">&quot;Do you wish to (r)evive them all, (s)elect components to revive, &quot;</span>
</span><span class='line'>            <span class="s">&quot;(c)ontinue without reviving, d(i)sable reviver, or (q)uit?&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nb">dict</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">choice_revive</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">s</span> <span class="o">=</span> <span class="n">choice_select</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">c</span> <span class="o">=</span> <span class="n">choice_continue</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">Q</span> <span class="o">=</span> <span class="n">choice_quit</span>
</span><span class='line'>                 <span class="p">),</span>
</span><span class='line'>            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;quit&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">choice_func</span><span class="p">()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>        <span class="k">except</span> <span class="n">InvalidChoiceError</span><span class="p">:</span>
</span><span class='line'>            <span class="k">continue</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This version has several advantages:</p>

<ul>
<li><p>It doesn't use "magic" to achieve the selection of the function. Duplication
is better than magic in this case, since it makes the code more readable.</p></li>
<li><p>The dictionary is created using the <code>dict()</code> syntax instead of the <code>{...}</code>
syntax, which gets rid of a lot of punctuation and makes the code clearer.</p></li>
</ul>


<h2>Conclusion</h2>

<p>It turns out that even in such a simple piece of code, several programming
techniques can be used to make the code clearer to read and maintain.</p>

<p>See you next time!</p>
]]></content>
  </entry>
  
</feed>
